#!/bin/bash

ensure_jq() {
  if [ ! -x "$(command -v jq)" ]; then
    if [ -x "$(command -v apt-get)" ]; then
      echo "ğŸ› ğŸ› ğŸ›  Installing 'jq' via 'apt-get'"
      apt-get update && apt-get install -y jq
    else
      echo "âš ï¸âš ï¸âš ï¸ apt-get not found, unable to automatically install 'jq'."
    fi
  fi
}

# Passes args to the scripts
run_build() {
  echo "ğŸ³ğŸ³ğŸ³ Building '${BUILD}' images"
  case ${BUILD} in
    release)
      # build the latest release
      # shellcheck disable=SC2068
      ./build-latest.sh $@
      ;;
    prerelease)
      # build the latest pre-release
      # shellcheck disable=SC2068
      PRERELEASE=true ./build-latest.sh $@
      ;;
    branches)
      # build all branches
      # shellcheck disable=SC2068
      ./build-branches.sh $@
      ;;
    this) # Pull Requests
      # only build the 'master' branch of netbox
      # (resulting in the 'latest' docker tag)
      # and the 'main' target.
      DOCKER_TARGET=main ./build.sh master
      ;;
    *)
      echo "ğŸš¨ Unrecognized build '$BUILD'."

      if [ -z "$DEBUG" ]; then
        exit 1
      else
        echo "âš ï¸ Would exit here with code '1', but DEBUG is enabled."
      fi
      ;;
  esac
}

env_info() {
  echo "â„¹ï¸ docker version"
  docker version

  echo "â„¹ï¸ docker-compose version"
  docker-compose version

  echo "â„¹ï¸ git version"
  git --version

  echo "â„¹ï¸ curl version"
  curl --version

  echo "â„¹ï¸ jq version"
  jq --version

  echo "â„¹ï¸ bash version"
  bash --version

  echo "â„¹ï¸ apt-get version"
  apt-get --version

  echo "â„¹ï¸ date version"
  date --version

  echo "â„¹ï¸ Netbox Docker VERSION"
  cat VERSION

  echo "â„¹ï¸ Netbox Docker git ref"
  git rev-parse HEAD
  git rev-parse --abbrev-ref HEAD
}


echo "ğŸ¤–ğŸ¤–ğŸ¤– Preparing build"
export DOCKER_ORG=netboxcommunity
export DOCKER_REPO=netbox
export DOCKER_REGISTRY=docker.io
# shellcheck disable=SC2153
export BUILD="${DOCKER_TAG}"

unset DOCKER_TAG

ensure_jq

echo "ğŸ¤–ğŸ¤–ğŸ¤– Build Environment Information"
env_info
